---
title: "NESS for single-cell data analysis"
author: "Xi Li, Jingyuan Hu"
output: 
  BiocStyle::html_document
vignette: >
  %\VignetteIndexEntry{NESS (Neighbor Embedding for Smooth Structures) for single-cell data analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


# Introduction

Data embedding methods are used to visualize high-dimensional single-cell RNA sequencing (scRNA-seq) data by projecting it into a low-dimensional space. Techniques like t-SNE, UMAP, and PHATE convert pairwise similarities between cells into probabilities, preserving local neighborhood structure. This helps identify cell populations and biological trajectories by clustering similar cells together.

The NESS (Neighbor Embedding for Smooth Structures) package builds on these methods by assessing and enhancing the quality of embeddings. It quantifies embedding stability across repeated runs, enabling us to evaluate reliability, select hyperparameters, and visualize uncertainty. NESS helps optimize neighbor embedding algorithms to extract robust, biologically meaningful insights from scRNA-seq data.

# Loading Preprocessed Data

We load a Mouse Hematopoiesis single-cell dataset that has already been processed using the standard Seurat pipeline.

```{r, results="hide", message=FALSE, warning=FALSE}
library(NESS)
library(tidyverse)
```

```{r}
# Load example data
load(system.file("Data", "mouse_hema_example_small.RData", package = "NESS"))

# Show dimensions of the expression matrix
dim(data_small)

# Show cell type distribution
table(cls_small)
```

# Running NESS across GCP Values

We assess the stability of t-SNE embeddings across different values of the global convergence parameter (GCP).

When running he `NESS()` function performs repeated runs of a selected dimensionality reduction method (t-SNE, UMAP, or PHATE) and evaluates the stability of local neighborhoods across embeddings. Below are descriptions of some important parameters used in the example below:

- `data`: A matrix or data frame containing the scaled gene expression data (cells × features).
- `GCP`: A vector of neighborhood sizes to test — this is analogous to `perplexity` in t-SNE or `n_neighbors` in UMAP/PHATE.
- `cell_type`: Optional vector of known labels for coloring plots.
- `rareness`: If `TRUE`, NESS computes a rareness score that identifies embeddings that deviate significantly from others.
- `method`: Dimensionality reduction algorithm to use (`"tsne"`, `"umap"`, or `"phateR"`).
- `initialization`: Set to `1` for random initialization, or `2` for PCA-based initialization.
- `N`: The number of independent embeddings to run per GCP value (e.g., 30).
- `k`: Number of nearest neighbors to use when computing stability (default = 50).
- `stability_threshold`: Quantile used to define local neighborhood stability (default = 0.75).
- `early_stop`: If `TRUE`, stops evaluation early if stability converges.

Note: Running NESS with multiple GCP values and repeated embeddings can take approximately 15 minutes depending on your machine and parameter settings. For faster prototyping, consider reducing `N` or using fewer GCP values.

```{r}
GCP = c(1,5,10,20,40,80,160)
result <- NESS(
    data = data_small,
    data.name = "mouse_hema",
    GCP = GCP,
    cluster = cls_small,
    rareness = TRUE,
    method = "tsne",
    initialization = 1,
    N = 20,
    k = 50,
    stability_threshold = 0.75,
    early_stop = FALSE
)
```

The output includes multiple visualizations and summary statistics.

# Results
## Local Stability Map
First, we plot the cell embedding visualization generated by optimal GCP score.
```{r}
# Embedding colored by cell type (if cell types were provided)
result$embedding_cluster_colored
```


The NESS Local Stability score measures how consistently each data point retains its neighbors across repeated embeddings. For a given point \( j \), the local stability score \( S_j \) is defined as the \( \lambda \)-quantile of its normalized neighbor counts:

$$
S_j = \text{Quantile}_\lambda \left( \left\{ \frac{K[j,l]}{N} : K[j,l] > 0, 1 \leq l \leq n \right\} \right)
$$

Here, \( K \) is the neighbor occurrence count matrix computed across \( N \) independent runs. We use \( \lambda = 0.75 \) by default.

```{r}
# Scatter plot colored by local stability
result$embedding_stability_colored
```

## Global Stability Trend

The Global Stability score summarizes the overall consistency of the embeddings. It is computed one per embedding as the average of all local stability scores across all data points:

$$
\text{Global Stability} = \frac{1}{n} \sum_{j=1}^n S_j
$$

A higher Global Stability score indicates that the neighbors of each data point are more consistently preserved across multiple runs. To select an appropriate GCP value, we recommend choosing the "knee" point with the smallest GCP that reach at least 0.9 stability score.

```{r}
# Global stability trend across GCP values
result$global_stability_plot
```

## Rareness Score
The NESS Rareness Score quantifies how dissimilar each low-dimensional embedding is from the others. It measures the extent to which a given embedding deviates from the remaining \( N - 1 \) embeddings in terms of neighborhood structure.

For each pair of embeddings \( i \) and \( j \), and for each data point \( l \), we compute \( w_{ij,l} \), the number of shared \( k \)-nearest neighbors. The similarity between embeddings \( i \) and \( j \) is defined as:

$$
W(i, j) = \text{median} \left( \left\{ \frac{w_{ij,l}}{k} : 1 \leq l \leq n \right\} \right)
$$

We then construct an \( N \times N \) similarity matrix \( W \). For each embedding \( i \), we compute the mean \( m_i \) and variance \( v_i \) of the \( i \)-th column in \( W \), excluding the diagonal. The Rareness Score \( R_i \) is defined as:

$$
R_i = \frac{1}{m_i v_i}
$$

A higher Rareness Score indicates that the embedding is more distinct from the others and may contain unique distortions or artifacts. This score is useful for identifying outlier embeddings that differ substantially from the consensus structure.

```{r}
# (Optional) Rareness score plot (if rareness = TRUE)
result$rareness_mean
```

# Session Info
```{r}
sessionInfo()
```
